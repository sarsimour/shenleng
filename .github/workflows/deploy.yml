name: Deploy Shenleng (Docker)

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          echo "ğŸ³ Building Docker image..."
          npm install --package-lock-only --legacy-peer-deps
          docker build -t shenleng-site:latest .
          docker save shenleng-site:latest | gzip > shenleng-site.tar.gz

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          # ä¼ è¾“é•œåƒã€é…ç½®ä»¥åŠæ•°æ®æº
          source: "shenleng-site.tar.gz,docker-compose.yml,nginx.conf,data/nextjs_content"
          target: "/home/${{ secrets.ECS_USER }}/Projects/shenleng"

      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 20m
          envs: PAYLOAD_SECRET
          script: |
            export PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}"
            PROJECT_DIR="/home/${{ secrets.ECS_USER }}/Projects/shenleng"
            cd "$PROJECT_DIR"

            # åœæ­¢æ—§æœåŠ¡
            if command -v pm2 &> /dev/null; then pm2 delete shenleng || true; fi
            docker compose down || true

            # å‡†å¤‡æŒ‚è½½ç›®å½•
            mkdir -p persistence/sqlite
            mkdir -p persistence/media
            
            # ã€æ ¸å¿ƒæ“ä½œã€‘å¼ºåˆ¶å°†æŒ‚è½½ç›®å½•çš„æ‰€æœ‰æƒäº¤ç»™ UID 1000 (å®¹å™¨å†…çš„ node ç”¨æˆ·)
            # ä½¿ç”¨ Alpine (root) æ‰§è¡Œ chownï¼Œæ— è§†å®¿ä¸»æœºç”¨æˆ·æƒé™é™åˆ¶
            echo "ğŸ”§ Fixing permissions to UID 1000..."
            docker run --rm -v $(pwd)/persistence:/target alpine chown -R 1000:1000 /target
            
            # ä¹Ÿå¯ä»¥é¡ºä¾¿ä¿®å¤ä¸€ä¸‹ä¸Šä¼ çš„æ•°æ®æºæƒé™ï¼Œç¡®ä¿å®¹æ˜“è¯»å–
            chmod -R 755 data/nextjs_content

            # åŠ è½½é•œåƒ
            echo "ğŸ“¥ Loading image..."
            docker load < shenleng-site.tar.gz

            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ Starting service..."
            echo "PAYLOAD_SECRET=$PAYLOAD_SECRET" > .env
            docker compose up -d

            # Nginx é…ç½® (ç¡®ä¿è½¯é“¾å­˜åœ¨)
            if [ ! -L /etc/nginx/sites-enabled/shenleng ]; then
                echo "Linking Nginx config..."
                sudo ln -sf "$PROJECT_DIR/nginx.conf" /etc/nginx/sites-enabled/shenleng
                sudo nginx -t && sudo nginx -s reload
            else
                sudo nginx -s reload
            fi

            # æ¸…ç†
            rm shenleng-site.tar.gz
            docker image prune -f