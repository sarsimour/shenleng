name: Deploy Shenleng (Bare Metal)

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. ä¼ è¾“æ‰€æœ‰ä»£ç æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 20m
          source: "."
          target: "/home/${{ secrets.ECS_USER }}/Projects/shenleng"
          # æ’é™¤ .git å’Œ node_modules (å¤ªå¤§)
          rm: true 

      # 2. åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œæ„å»ºå’Œå¯åŠ¨
      - name: Setup & Start Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          # ä¼ é€’ç¯å¢ƒå˜é‡
          envs: PAYLOAD_SECRET
          script: |
            export PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}"
            export NODE_ENV=production
            export PROJECT_DIR="/home/${{ secrets.ECS_USER }}/Projects/shenleng"
            
            # --- 0. åœæ­¢æ—§çš„ Docker å®¹å™¨ (å¦‚æœå­˜åœ¨) ---
            echo "ğŸ›‘ Stopping any legacy Docker containers..."
            docker stop shenleng-container || true
            docker rm shenleng-container || true

            # --- 1. ç¯å¢ƒå‡†å¤‡ (å®‰è£… NVM å’Œ Node 20) ---
            echo "ğŸ”§ Checking Node.js environment..."
            if ! command -v node &> /dev/null; then
                echo "Installing NVM and Node.js..."
                curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                nvm install 20
                nvm use 20
                nvm alias default 20
            else
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                nvm use 20 || nvm install 20
            fi

            # å®‰è£…å…¨å±€ PM2
            if ! command -v pm2 &> /dev/null; then
                npm install -g pm2
            fi

            # --- 2. ä¾èµ–å®‰è£…ä¸æ„å»º ---
            cd "$PROJECT_DIR"
            echo "ğŸ“¦ Installing dependencies..."
            # å¼ºåˆ¶å®‰è£… sharp çš„ linux x64 ç‰ˆæœ¬ï¼Œé¿å… MacOS ä¸Šä¼ åçš„å…¼å®¹æ€§é—®é¢˜
            npm install --platform=linux --arch=x64 sharp
            npm install --legacy-peer-deps

            echo "ğŸ—ï¸ Building application..."
            # ç¡®ä¿ç¯å¢ƒå˜é‡å­˜åœ¨
            echo "PAYLOAD_SECRET=$PAYLOAD_SECRET" > .env
            echo "DATABASE_URI=file:./payload.db" >> .env
            
            npm run build

            # --- 3. å¯åŠ¨æœåŠ¡ (PM2) ---
            echo "ğŸš€ Starting application with PM2..."
            # å¦‚æœè¿›ç¨‹å·²å­˜åœ¨ï¼Œé‡è½½å®ƒï¼›å¦åˆ™å¯åŠ¨å®ƒ
            if pm2 list | grep -q "shenleng"; then
                pm2 reload shenleng
            else
                pm2 start npm --name "shenleng" -- start -- --port 3000
            fi
            
            # ä¿å­˜ PM2 åˆ—è¡¨ï¼Œç¡®ä¿å¼€æœºè‡ªå¯ (éœ€è¦ sudo æƒé™æ‰§è¡Œ pm2 startupï¼Œè¿™é‡Œå°½åŠ›è€Œä¸º)
            pm2 save

            # --- 4. Nginx é…ç½®æç¤º ---
            echo "ğŸŒ Nginx configuration reminder:"
            echo "Please ensure /etc/nginx/sites-enabled/shenleng exists and points to $PROJECT_DIR/nginx.conf"
            echo "You might need to run: sudo ln -sf $PROJECT_DIR/nginx.conf /etc/nginx/sites-enabled/shenleng && sudo nginx -s reload"
            
            echo "âœ… Deployment Complete!"