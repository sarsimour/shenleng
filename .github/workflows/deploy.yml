name: Deploy Shenleng (Docker)

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          echo "ğŸ³ Building Docker image..."
          npm install --package-lock-only --legacy-peer-deps
          docker build -t shenleng-site:latest .
          docker save shenleng-site:latest | gzip > shenleng-site.tar.gz

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          # å°†åŸå§‹æ•°æ®ä¹Ÿä¸€å¹¶ä¼ ä¸Šå»ï¼Œæ”¾åœ¨é¡¹ç›®ç›®å½•ä¸‹
          source: "shenleng-site.tar.gz,docker-compose.yml,nginx.conf,data/nextjs_content"
          target: "/home/${{ secrets.ECS_USER }}/Projects/shenleng"

      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 20m
          envs: PAYLOAD_SECRET
          script: |
            export PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}"
            PROJECT_DIR="/home/${{ secrets.ECS_USER }}/Projects/shenleng"
            cd "$PROJECT_DIR"
            
            # åœæ­¢æ—§æœåŠ¡
            # å¦‚æœä¹‹å‰æœ‰è£¸é‡‘å±éƒ¨ç½²çš„ PM2ï¼Œå…ˆæ€æ‰
            if command -v pm2 &> /dev/null; then pm2 delete shenleng || true; fi
            docker compose down || true

            # åˆ›å»ºç›®å½•
            mkdir -p persistence/sqlite
            mkdir -p persistence/media
            
            # æç¤ºç”¨æˆ·æƒé™
            echo "âš ï¸  REMINDER: Please ensure 'persistence' and 'data/nextjs_content' are owned by UID 1000"
            echo "âš ï¸  Run: sudo chown -R 1000:1000 persistence/ data/nextjs_content"

            # å¯¼å…¥é•œåƒ
            echo "ğŸ“¥ Loading image..."
            docker load < shenleng-site.tar.gz

            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ Starting service..."
            echo "PAYLOAD_SECRET=$PAYLOAD_SECRET" > .env
            docker compose up -d --remove-orphans

            # Nginx é‡è½½
            # å°è¯•è‡ªåŠ¨é“¾æ¥
            if [ ! -L /etc/nginx/sites-enabled/shenleng ]; then
               sudo ln -sf "$PROJECT_DIR/nginx.conf" /etc/nginx/sites-enabled/shenleng
            fi
            sudo nginx -t && sudo nginx -s reload

            # æ¸…ç†
            rm shenleng-site.tar.gz
            docker image prune -f
            echo "âœ… Deployment successful!"
