name: Deploy Shenleng Site

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          echo "ğŸ³ Building Docker image..."
          # ç¡®ä¿ä¾èµ–å®‰è£…
          npm install --package-lock-only --legacy-peer-deps
          
          # æ„å»ºé•œåƒ
          docker build -t shenleng-site:latest .
          
          echo "ğŸ“¦ Compressing image..."
          docker save shenleng-site:latest | gzip > shenleng-site.tar.gz

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 10m
          source: "shenleng-site.tar.gz,docker-compose.yml"
          target: "/home/${{ secrets.ECS_USER }}/Projects/shenleng"

      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 10m
          envs: PAYLOAD_SECRET
          script: |
            set -e
            PROJECT_DIR="/home/${{ secrets.ECS_USER }}/Projects/shenleng"
            cd "$PROJECT_DIR"

            echo "ğŸ“‚ Ensuring directory structure..."
            # åˆ›å»ºæŒä¹…åŒ–ç›®å½•
            mkdir -p persistence/sqlite
            mkdir -p persistence/media
            
            # ç¡®ä¿å½“å‰ç”¨æˆ·æ‹¥æœ‰è¿™äº›ç›®å½•çš„æ‰€æœ‰æƒ (é’ˆå¯¹ä¹‹å‰å¯èƒ½è¢« root ç¯¡æ”¹è¿‡çš„æƒé™)
            # ä½¿ç”¨ sudo æ˜¯ä¸ºäº†ä¿®å¤å¯èƒ½å­˜åœ¨çš„æ—§æƒé™é—®é¢˜ï¼Œå¦‚æœ ecs_user æ²¡æœ‰ sudo æƒé™ï¼Œè¿™è¡Œå¯èƒ½ä¼šå¤±è´¥
            # å¦‚æœå¤±è´¥ï¼Œé€šå¸¸æ„å‘³ç€å·²ç»æ˜¯ ecs_user æ‰€æœ‰çš„ï¼Œæˆ–è€…æ— æƒä¿®æ”¹ã€‚
            # ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨ docker è¿™ç§ trick æ¥ä¿®å¤æƒé™ï¼Œæˆ–è€…å‡è®¾ä¹‹å‰çš„é—®é¢˜å·²è§£å†³ã€‚
            # æ—¢ç„¶ä¹‹å‰çš„ workflow ç”¨äº† docker fixï¼Œæˆ‘ä»¬ä¿ç•™è¿™ä¸ª trick ä½œä¸ºä¿é™©ï¼Œä½†æ”¹ä¸º chown ç»™ uid 1000
            
            echo "ğŸ”§ Ensuring permissions match UID 1000..."
            docker run --rm -v $(pwd)/persistence:/target alpine chown -R 1000:1000 /target

            echo "ğŸ“¥ Loading Docker image..."
            docker load < shenleng-site.tar.gz

            echo "ğŸš€ Starting service with Docker Compose..."
            # åˆ›å»º .env æ–‡ä»¶ä¾› docker-compose ä½¿ç”¨
            echo "PAYLOAD_SECRET=${{ secrets.PAYLOAD_SECRET }}" > .env
            
            # åœæ­¢æ—§å®¹å™¨ (å…¼å®¹æ—§çš„ docker run æ–¹å¼å¯åŠ¨çš„å®¹å™¨)
            docker stop shenleng-container || true
            docker rm shenleng-container || true
            
            # å¯åŠ¨æ–°æœåŠ¡
            docker compose up -d --remove-orphans

            # æ¸…ç†
            rm shenleng-site.tar.gz
            docker image prune -f
            
            echo "âœ… Deployment successful!"
