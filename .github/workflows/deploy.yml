name: Deploy Shenleng (Docker + GHCR)

on:
  push:
    branches: ["master"]

env:
  # é•œåƒåœ°å€: ghcr.io/ç”¨æˆ·å/ä»“åº“å:latest
  # âš ï¸ æ³¨æ„: GHCR è¦æ±‚ç”¨æˆ·åå’Œä»“åº“åå¿…é¡»å°å†™
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/sarsimour/shenleng:latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # å…è®¸ä¸Šä¼ é•œåƒåˆ° GHCR

    steps:
      - uses: actions/checkout@v4

      # 1. ç™»å½• GitHub Container Registry
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 2. æ„å»ºå¹¶æ¨é€é•œåƒ (ä¸å†ç”Ÿæˆ tar åŒ…)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}

      # 3. ä¼ è¾“æ•°æ®å’Œé…ç½® (æ’é™¤å¤§é•œåƒæ–‡ä»¶)
      - name: Copy Config & Data to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          # åªä¼ é…ç½®
          source: "docker-compose.yml,nginx.conf"
          target: "/home/${{ secrets.ECS_USER }}/Projects/shenleng"

      # 4. æœåŠ¡å™¨éƒ¨ç½²
      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 20m
          # å°† GITHUB_TOKEN ä¼ ç»™æœåŠ¡å™¨ç”¨äºæ‹‰å–é•œåƒ
          envs: PAYLOAD_SECRET, IMAGE_NAME, REGISTRY
          script: |
            export PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}"
            export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}" 
            PROJECT_DIR="/home/${{ secrets.ECS_USER }}/Projects/shenleng"
            cd "$PROJECT_DIR"

            # åœæ­¢æ—§æœåŠ¡
            docker compose down || true

            # å‡†å¤‡ç›®å½•
            mkdir -p persistence/sqlite
            mkdir -p persistence/media
            
            # æç¤ºæƒé™è®¾ç½® (é‡è¦!)
            echo "ğŸ”§ Ensuring permissions..."
            # å°è¯•è‡ªåŠ¨ä¿®å¤ (å¦‚æœ sudo å…å¯†)
            if sudo -n true 2>/dev/null; then
              sudo chown -R 1000:1000 persistence/
              sudo chmod -R 755 data/nextjs_content
            else
              echo "âš ï¸ Please run: sudo chown -R 1000:1000 ~/Projects/shenleng/persistence"
            fi

            # ç™»å½• GHCR å¹¶æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ Pulling image from GHCR..."
            # ä½¿ç”¨ä¸´æ—¶çš„ PAT æˆ–ç›´æ¥å…¬å¼€åŒ…ã€‚è¿™é‡Œå°è¯•ç”¨ GITHUB_TOKEN ç™»å½• (æœ‰æ—¶å—é™äº IP)
            # å¦‚æœå¤±è´¥ï¼Œè¯·å°†è¯¥ Package åœ¨ GitHub é¡µé¢è®¾ä¸º Public
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ${{ env.IMAGE_NAME }}

            # æ›´æ–° docker-compose ä¸­çš„é•œåƒå
            # ä½¿ç”¨ sed æ›¿æ¢ image: shenleng-site:latest -> image: ghcr.io/...
            sed -i "s|image: .*|image: ${{ env.IMAGE_NAME }}|g" docker-compose.yml

            # å¯åŠ¨æœåŠ¡
            echo "PAYLOAD_SECRET=$PAYLOAD_SECRET" > .env
            docker compose up -d --remove-orphans

            # Nginx åˆ·æ–°
            sudo nginx -s reload || true

            # æ¸…ç†æ—§é•œåƒ
            docker image prune -f