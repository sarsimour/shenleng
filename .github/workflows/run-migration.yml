name: Run Content Migration

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. ä¸Šä¼ æ•°æ®æ–‡ä»¶ (æ’é™¤ä¸éœ€è¦çš„å¤§æ–‡ä»¶å¦‚æœå¯èƒ½ï¼Œä½†è¿™é‡Œç›´æ¥ä¼ æ•´ä¸ªç›®å½•)
      - name: Upload Data to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          source: "data/nextjs_content"
          target: "/home/${{ secrets.ECS_USER }}/temp_migration_source"

      # 2. è¿è¡Œè¿ç§»è„šæœ¬
      - name: Execute Migration in Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          script: |
            SOURCE_DIR="/home/${{ secrets.ECS_USER }}/temp_migration_source/data/nextjs_content"
            PROJECT_DIR="/home/${{ secrets.ECS_USER }}/Projects/shenleng"
            
            echo "ğŸ“‚ Data source: $SOURCE_DIR"
            
            # ç¡®ä¿æ•°æ®ç›®å½•æƒé™å¯è¯»
            # å› ä¸º Docker é‡Œæ˜¯ node ç”¨æˆ· (uid 1000)ï¼Œç¡®ä¿å®ƒèƒ½è¯»å–æ˜ å°„è¿›æ¥çš„æ–‡ä»¶
            chmod -R 755 /home/${{ secrets.ECS_USER }}/temp_migration_source
            
            echo "ğŸš€ Starting migration container..."
            
            # ä½¿ç”¨ä¸ç”Ÿäº§ç¯å¢ƒç›¸åŒçš„é•œåƒ
            docker run --rm \
              --user node \
              -v "$PROJECT_DIR/persistence/sqlite":/app/database \
              -v "$PROJECT_DIR/persistence/media":/app/public/media \
              -v "$SOURCE_DIR":/app/migration_data \
              -e PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}" \
              -e DATABASE_URI="file:/app/database/payload.db" \
              -e PAYLOAD_CONFIG_PATH="src/payload.config.ts" \
              -e MIGRATION_DATA_DIR="/app/migration_data" \
              shenleng-site:latest \
              npx tsx scripts/migrate_server_local.ts

            echo "âœ… Migration finished."
            
            # æ¸…ç†
            rm -rf /home/${{ secrets.ECS_USER }}/temp_migration_source
