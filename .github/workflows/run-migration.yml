name: Run Migration (Docker)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Execute Migration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          envs: PAYLOAD_SECRET
          script: |
            export PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}"
            
            echo "üõë Stopping web container..."
            docker stop shenleng-container || true
            
            echo "üì• Pulling latest image..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ghcr.io/sarsimour/shenleng:latest
            
            echo "üöÄ Running migration container..."
            docker run --rm \
                --user "1000:1000" \
                -v ~/data/shenleng/persistence/sqlite:/app/database \
                -v ~/data/shenleng/persistence/media:/app/public/media \
                -v ~/data/shenleng/migration_source:/app/migration_data \
                -e PAYLOAD_SECRET="$PAYLOAD_SECRET" \
                -e DATABASE_URI="file:/app/database/payload.db" \
                -e PAYLOAD_CONFIG_PATH="src/payload.config.ts" \
                -e MIGRATION_DATA_DIR="/app/migration_data" \
                ghcr.io/sarsimour/shenleng:latest \
                npx tsx src/scripts/migrate_server_local.ts
            
            echo "‚ñ∂Ô∏è Restarting web container..."
            cd ~/Projects/shenleng && docker compose up -d
            
            echo "‚úÖ Migration Complete!"