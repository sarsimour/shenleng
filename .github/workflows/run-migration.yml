name: Run Migration (Direct)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      # 1. ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä¸éœ€è¦ä¸Šä¼ ä»£ç ï¼ˆå‡è®¾ deploy å·²ç»æŠŠä»£ç ä¼ ä¸Šå»äº†ï¼‰
      - name: Execute Migration on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          timeout: 30m
          envs: PAYLOAD_SECRET
          script: |
            export PAYLOAD_SECRET="${{ secrets.PAYLOAD_SECRET }}"
            PROJECT_DIR="/home/${{ secrets.ECS_USER }}/Projects/shenleng"
            
            cd "$PROJECT_DIR"
            
            echo "ğŸ›‘ Stopping application to release DB lock..."
            pm2 stop shenleng || true
            
            echo "ğŸš€ Running migration script..."
            # ä½¿ç”¨é¡¹ç›®æœ¬åœ°çš„ npx å’Œ tsx
            npx tsx scripts/migrate_server_local.ts
            
            echo "â–¶ï¸ Restarting application..."
            pm2 start shenleng || pm2 restart shenleng
            
            echo "âœ… Done!"